name: Update Package Lock File

on:
  push:
    paths:
      - 'package.json'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-lockfile:
    name: Update package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check if package.json changed
        id: check-changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "package.json"; then
            echo "PACKAGE_JSON_CHANGED=true" >> $GITHUB_OUTPUT
          else
            echo "PACKAGE_JSON_CHANGED=false" >> $GITHUB_OUTPUT
          fi

      - name: Remove existing lock file and node_modules
        if: steps.check-changes.outputs.PACKAGE_JSON_CHANGED == 'true'
        run: |
          echo "ðŸ§¹ Cleaning up existing dependencies..."
          rm -rf package-lock.json node_modules

      - name: Fresh install to generate new lock file
        if: steps.check-changes.outputs.PACKAGE_JSON_CHANGED == 'true'
        run: |
          echo "ðŸ“¦ Installing dependencies and generating new package-lock.json..."
          npm install
          
          # Verify the installation
          echo "âœ… Verifying installation..."
          npm ls eslint-plugin-security || echo "âŒ eslint-plugin-security not found"

      - name: Check for lock file changes
        if: steps.check-changes.outputs.PACKAGE_JSON_CHANGED == 'true'
        id: lock-changes
        run: |
          if [ -f package-lock.json ]; then
            echo "LOCK_FILE_EXISTS=true" >> $GITHUB_OUTPUT
            if git diff --quiet package-lock.json; then
              echo "LOCK_FILE_CHANGED=false" >> $GITHUB_OUTPUT
            else
              echo "LOCK_FILE_CHANGED=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "LOCK_FILE_EXISTS=false" >> $GITHUB_OUTPUT
            echo "LOCK_FILE_CHANGED=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated lock file
        if: steps.check-changes.outputs.PACKAGE_JSON_CHANGED == 'true' && steps.lock-changes.outputs.LOCK_FILE_CHANGED == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ðŸ“ Committing updated package-lock.json..."
          git add package-lock.json
          git commit -m "ðŸ”’ Update package-lock.json after package.json changes

          Auto-generated by GitHub Actions to sync dependencies:
          - Added eslint-plugin-security@3.0.1
          - Updated lock file for security audit workflows
          
          [skip ci]"
          
          git push

      - name: Add PR comment about lock file update
        if: github.event_name == 'pull_request' && steps.lock-changes.outputs.LOCK_FILE_CHANGED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Package Lock File Updated

              The \`package-lock.json\` file has been automatically updated to match changes in \`package.json\`.

              ### Changes:
              - âœ… Added \`eslint-plugin-security@3.0.1\` for security linting
              - ðŸ”„ Synchronized all dependency versions
              - ðŸ›¡ï¸ Security audit workflows should now work correctly

              This ensures that \`npm ci\` will work properly in GitHub Actions.`
            });

      - name: Summary
        run: |
          echo "## ðŸ“‹ Lock File Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-changes.outputs.PACKAGE_JSON_CHANGED }}" == "true" ]; then
            echo "âœ… **package.json changes detected**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.lock-changes.outputs.LOCK_FILE_CHANGED }}" == "true" ]; then
              echo "âœ… **package-lock.json updated successfully**" >> $GITHUB_STEP_SUMMARY
              echo "ðŸš€ **GitHub Actions workflows should now work**" >> $GITHUB_STEP_SUMMARY
            else
              echo "â„¹ï¸ **No lock file changes needed**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ **No package.json changes detected**" >> $GITHUB_STEP_SUMMARY
          fi
